<!DOCTYPE html>
<html>

<head>
    <title>Employee Management</title>
    <style>
        body {
            font-family: Arial;
            margin: 40px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f4f4f4;
        }

        button {
            margin: 2px;
        }

        .error {
            color: red;
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <h2>Create / Edit Employee</h2>

    <form id="employeeForm">
        <input type="hidden" id="employee_id">

        <input type="text" id="username" placeholder="Username"><br><br>
        <input type="password" id="password" placeholder="Password"><br><br>
        <input type="text" id="first_name" placeholder="First Name"><br><br>
        <input type="text" id="last_name" placeholder="Last Name"><br><br>
        <input type="text" id="email" placeholder="Email"><br><br>
        <input type="text" id="phone_number" placeholder="Phone (+1234567890)"><br><br>
        <input type="number" id="age" placeholder="Age"><br><br>
        <input type="text" id="role" placeholder="Role"><br><br>
        <input type="number" id="salary" placeholder="Salary"><br><br>
        <input type="text" id="employment_type" placeholder="Employment Type"><br><br>
        <input type="date" id="contract_end_date"><br><br>

        <button type="submit">Submit</button>
    </form>

    <div class="error" id="errorBox"></div>

    <hr>

    <h2>Employees</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Salary</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="employeeTable"></tbody>
    </table>

    <script>

        window.onload = function () {

            const API_URL = "http://127.0.0.1:8000";

            function getToken() {
                return localStorage.getItem("token");
            }

            if (!getToken()) {
                window.location.href = "login.html";
            }

            document.getElementById("employeeForm").addEventListener("submit", async function (e) {
                e.preventDefault();
                clearErrors();

                const employeeId = document.getElementById("employee_id").value;

                const payload = {
                    ...(employeeId ? {} : { username: username.value }),
                    ...(employeeId ? {} : { password: password.value }),
                    first_name: first_name.value,
                    last_name: last_name.value,
                    email: email.value,
                    phone_number: phone_number.value,
                    age: parseInt(age.value),
                    role: role.value,
                    salary: parseFloat(salary.value),
                    employment_type: employment_type.value,
                    contract_end_date: contract_end_date.value || null
                };

                let url = `${API_URL}/employees/`;
                let method = "POST";

                if (employeeId) {
                    url += employeeId;
                    method = "PUT";
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + getToken()
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    showErrors(data);
                    return;
                }

                document.getElementById("employeeForm").reset();
                document.getElementById("employee_id").value = "";

                username.disabled = false;
                password.style.display = "block";

                loadEmployees();
            });

            async function loadEmployees() {
                const response = await fetch(`${API_URL}/employees/`, {
                    headers: {
                        "Authorization": "Bearer " + getToken()
                    }
                });

                const employees = await response.json();

                const table = document.getElementById("employeeTable");
                table.innerHTML = "";

                employees.forEach(emp => {
                    const row = document.createElement("tr");

                    row.innerHTML = `
                <td>${emp.id}</td>
                <td>${emp.first_name} ${emp.last_name}</td>
                <td>${emp.email}</td>
                <td>${emp.role}</td>
                <td>${emp.salary}</td>
                <td>
                    <button onclick="editEmployee(${emp.id})">Edit</button>
                    <button onclick="deleteEmployee(${emp.id})">Delete</button>
                </td>
            `;

                    table.appendChild(row);
                });
            }

            window.editEmployee = async function (id) {
                const response = await fetch(`${API_URL}/employees/${id}`, {
                    headers: {
                        "Authorization": "Bearer " + getToken()
                    }
                });

                const emp = await response.json();

                document.getElementById("employee_id").value = emp.id;

                username.value = emp.username;
                username.disabled = true;

                password.style.display = "none";

                first_name.value = emp.first_name;
                last_name.value = emp.last_name;
                email.value = emp.email;
                phone_number.value = emp.phone_number;
                age.value = emp.age;
                role.value = emp.role;
                salary.value = emp.salary;
                employment_type.value = emp.employment_type;
                contract_end_date.value = emp.contract_end_date || "";
            }

            window.deleteEmployee = async function (id) {
                if (!confirm("Are you sure?")) return;

                const response = await fetch(`${API_URL}/employees/${id}`, {
                    method: "DELETE",
                    headers: {
                        "Authorization": "Bearer " + getToken()
                    }
                });

                if (response.ok) loadEmployees();
            }

            function showErrors(data) {
                const errorBox = document.getElementById("errorBox");

                if (data.detail && Array.isArray(data.detail)) {
                    errorBox.innerHTML = data.detail.map(err =>
                        `${err.loc[1]}: ${err.msg}`
                    ).join("<br>");
                } else if (data.detail) {
                    errorBox.innerHTML = data.detail;
                } else {
                    errorBox.innerHTML = "Something went wrong";
                }
            }

            function clearErrors() {
                document.getElementById("errorBox").innerHTML = "";
            }

            loadEmployees();
        };

    </script>

</body>

</html>